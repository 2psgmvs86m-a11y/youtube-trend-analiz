<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piyasa Analizi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #fdfdfd; /* √áok hafif kƒ±rƒ±k beyaz */
            --text-main: #212529;
            --text-muted: #6c757d;
            --pill-pink-bg: #f8d7da; /* G√∂rseldeki pembe tonu */
            --pill-pink-text: #721c24;
            --accent-green: #28a745;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        /* √úst Navigasyon (G√∂rseldeki Mor Linkler Tarzƒ±) */
        .top-nav { padding: 15px 0; margin-bottom: 20px; }
        .top-nav ul { list-style: none; padding: 0; display: flex; gap: 20px; align-items: center; }
        .top-nav a { text-decoration: none; color: #4a4a4a; font-weight: 600; font-size: 0.95rem; border-bottom: 2px solid transparent; }
        .top-nav a:hover, .top-nav a.active { color: #6f42c1; border-bottom-color: #6f42c1; } /* Mor vurgu */

        /* Ana Ba≈ülƒ±k Alanƒ± */
        .main-title { font-size: 2.5rem; font-weight: 800; line-height: 1.2; letter-spacing: -0.5px; color: #000; }
        
        /* Saƒü √úst Kontroller (Pill ≈ûeklinde) */
        .control-pill {
            background: #e9ecef; border-radius: 20px; padding: 5px 15px; 
            border: none; font-size: 0.9rem; font-weight: 600; color: #495057;
            margin-left: 10px; cursor: pointer;
        }
        .btn-analyze { background: #e9ecef; color: #0d6efd; } /* Mavi tonlu buton */

        /* Sol Kolon: Etiketler */
        .section-title { font-size: 1.25rem; font-weight: 800; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .section-desc { font-size: 0.95rem; color: #6c757d; margin-bottom: 20px; line-height: 1.5; }

        .tag-item {
            display: block; /* Alt alta veya blok g√∂r√ºn√ºm */
            background-color: var(--pill-pink-bg);
            color: var(--pill-pink-text);
            padding: 8px 15px;
            border-radius: 8px; /* Hafif k√∂≈üe */
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            width: fit-content;
        }

        /* Saƒü Kolon: ƒ∞statistikler */
        .stat-block { margin-bottom: 25px; }
        .stat-text { font-size: 1.1rem; color: #333; line-height: 1.5; }
        .stat-highlight { font-weight: 800; color: #000; }
        .score-green { color: var(--accent-green); font-weight: 800; }
        
        /* Y√ºkleniyor */
        #loader { display: none; }
        
        /* Alt Video Tablosu (Basit) */
        .video-row { padding: 10px 0; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; }
        .video-row img { width: 60px; height: 34px; object-fit: cover; border-radius: 4px; }
        .video-link { text-decoration: none; color: #333; font-weight: 600; font-size: 0.9rem; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;}
    </style>
</head>
<body>

    <div class="container">
        
        <div class="top-nav">
            <ul>
                <li><a href="/">Ana Sayfa</a></li>
                <li><a href="/analiz" class="active">üìä Detaylƒ± Trendler</a></li>
                <li><a href="/sorgula">üîç Kanal Sorgula</a></li>
            </ul>
        </div>

        <div class="row align-items-start mb-5">
            <div class="col-8">
                <h1 class="main-title">üìä Piyasa<br>Analizi & Ni≈ü<br>Ke≈üfi</h1>
            </div>
            <div class="col-4 text-end">
                <div class="d-flex flex-column align-items-end gap-2">
                    <select id="regionSelect" class="control-pill">
                        <option value="TR">T√ºrkiye</option>
                        <option value="US">ABD</option>
                        <option value="DE">Almanya</option>
                    </select>
                    <button class="control-pill btn-analyze" onclick="fetchTrends()">Analiz Et</button>
                </div>
            </div>
        </div>

        <div id="loader" class="text-center py-5">
            <div class="spinner-border text-secondary" role="status"></div>
        </div>

        <div class="row" id="results-area" style="display: none;">
            
            <div class="col-md-6 mb-5">
                <h3 class="section-title">üîë En √áok Aranan<br>Anahtar Kelimeler</h3>
                <p class="section-desc">Trend videolarda en sƒ±k<br>ge√ßen ve rekabet<br>yaratan kelimeler.</p>
                
                <div id="tag-list">
                    </div>
            </div>

            <div class="col-md-6">
                <h3 class="section-title">‚ö° Rekabet / Ni≈ü<br>Durumu</h3>
                
                <div class="stat-block">
                    <div class="stat-text">
                        Bu b√∂lgedeki trendlerde toplam<br>
                        <span class="stat-highlight" id="total-tags">0</span> etiket kullanƒ±ldƒ±.
                    </div>
                </div>

                <div class="stat-block">
                    <div class="stat-text">
                        Baskƒ±n Kategori:<br>
                        <span class="stat-highlight" id="dominant-cat">-</span><br>
                        <small class="text-muted">(Otomatik Tespit)</small>
                    </div>
                </div>

                <div class="stat-block">
                    <div class="stat-text">
                        Fƒ±rsat Skoru: <span id="opp-score-text">-</span><br>
                        <small class="text-muted" id="opp-desc">-</small>
                    </div>
                </div>
            </div>
        </div>

        <div id="video-area" class="mt-4 mb-5" style="display: none;">
            <hr class="mb-4">
            <h5 class="fw-bold mb-3">Trend Kaynaklarƒ±</h5>
            <div id="video-list-container"></div>
        </div>

    </div>

    <script>
        async function fetchTrends() {
            const region = document.getElementById('regionSelect').value;
            document.getElementById('loader').style.display = 'block';
            document.getElementById('results-area').style.display = 'none';
            document.getElementById('video-area').style.display = 'none';

            try {
                const res = await fetch(`/api/trending?region=${region}&limit=20`);
                const data = await res.json();
                renderPage(data);
            } catch (e) {
                alert("Veri √ßekilemedi.");
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        function renderPage(videos) {
            // 1. Etiketleri Topla
            let allTags = [];
            videos.forEach(v => {
                if(v.tags) {
                    // String gelme ihtimaline kar≈üƒ± temizlik
                    let tags = [];
                    if(Array.isArray(v.tags)) tags = v.tags;
                    else try { tags = JSON.parse(v.tags.replace(/'/g, '"')); } catch(e){}
                    allTags = allTags.concat(tags);
                }
            });

            // 2. Say ve Sƒ±rala
            const counts = {};
            allTags.forEach(t => { 
                let key = t.toLowerCase();
                counts[key] = (counts[key] || 0) + 1; 
            });
            const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 8); // ƒ∞lk 8 tanesi g√∂rseldeki gibi

            // 3. SOL TARAFI DOLDUR (Pembe Etiketler)
            const tagContainer = document.getElementById('tag-list');
            tagContainer.innerHTML = '';
            sorted.forEach(([tag, count]) => {
                tagContainer.innerHTML += `
                    <div class="tag-item">#${tag} (${count})</div>
                `;
            });

            // 4. SAƒû TARAFI DOLDUR (ƒ∞statistikler)
            document.getElementById('total-tags').innerText = allTags.length;
            
            // Kategori Tahmini
            let topText = sorted.map(x=>x[0]).join(" ");
            let cat = "Karƒ±≈üƒ±k / Genel";
            if(topText.includes("oyun") || topText.includes("minecraft") || topText.includes("roblox")) cat = "Eƒülence & Vlog";
            else if(topText.includes("haber") || topText.includes("siyaset")) cat = "Haber & G√ºndem";
            else if(topText.includes("dizi") || topText.includes("fragman")) cat = "Dizi & Film";
            
            document.getElementById('dominant-cat').innerText = cat;

            // Skor Hesapla
            const uniqueRatio = Object.keys(counts).length / (allTags.length || 1);
            const scoreEl = document.getElementById('opp-score-text');
            const descEl = document.getElementById('opp-desc');

            if(uniqueRatio > 0.5) {
                scoreEl.innerHTML = 'Y√ºksek';
                scoreEl.className = 'score-green'; // Ye≈üil Yazƒ±
                descEl.innerText = '(√áe≈üitlilik Var)';
            } else {
                scoreEl.innerHTML = 'D√º≈ü√ºk';
                scoreEl.style.color = '#dc3545'; // Kƒ±rmƒ±zƒ± Yazƒ±
                descEl.innerText = '(Rekabet √áok Y√ºksek)';
            }

            // 5. Videolarƒ± Listele
            const vidContainer = document.getElementById('video-list-container');
            vidContainer.innerHTML = '';
            videos.slice(0,5).forEach(v => {
                vidContainer.innerHTML += `
                    <div class="video-row">
                        <img src="${v.thumbnail}">
                        <a href="${v.url}" target="_blank" class="video-link">${v.title}</a>
                    </div>
                `;
            });

            document.getElementById('results-area').style.display = 'flex';
            document.getElementById('video-area').style.display = 'block';
        }
        
        // Sayfa a√ßƒ±lƒ±nca otomatik analiz etsin mi? (Opsiyonel)
        // window.onload = fetchTrends; 
    </script>
</body>
</html>
