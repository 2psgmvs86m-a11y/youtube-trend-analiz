<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trend & Piyasa Analizi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --sb-red: #c4302b;
            --sb-dark: #1d1d1d;
            --sb-gray: #f8f9fa;
        }
        body { background-color: #eef2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Navbar */
        .navbar { background-color: var(--sb-dark); border-bottom: 4px solid var(--sb-red); }
        .navbar-brand { font-weight: bold; color: white !important; letter-spacing: 1px; }
        .navbar-brand span { color: var(--sb-red); background: white; padding: 2px 5px; border-radius: 3px; margin-right: 5px;}
        .nav-link { color: rgba(255,255,255,0.8) !important; }
        .nav-link:hover, .nav-link.active { color: white !important; font-weight: bold; }

        /* Kartlar */
        .analysis-card {
            background: white; border-radius: 4px; border-top: 3px solid var(--sb-dark);
            padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .card-header-custom {
            font-weight: bold; font-size: 1.1rem; margin-bottom: 15px; 
            border-bottom: 1px solid #eee; padding-bottom: 10px;
            color: var(--sb-dark);
        }

        /* Etiketler (Keyword Cloud) */
        .tag-cloud { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag-pill {
            background-color: #f1f1f1; color: #333; padding: 6px 12px; 
            border-radius: 20px; font-size: 0.9rem; font-weight: 500;
            border: 1px solid #ddd; display: flex; align-items: center;
        }
        .tag-pill span {
            background: var(--sb-red); color: white; border-radius: 50%;
            width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;
            font-size: 0.75rem; margin-left: 8px;
        }

        /* Skorlar */
        .score-text { font-size: 2rem; font-weight: bold; }
        .text-high { color: #28a745; } /* Yeşil */
        .text-med { color: #ffc107; }  /* Sarı */
        .text-low { color: #dc3545; }  /* Kırmızı */

        /* Yükleniyor */
        .loader { display: none; border: 5px solid #f3f3f3; border-top: 5px solid var(--sb-red); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/"><i class="fab fa-youtube"></i> <span>TR</span> ANALYZER</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link" href="/" data-key="menu_home">Ana Sayfa</a></li>
                    <li class="nav-item"><a class="nav-link" href="/sorgula" data-key="menu_query">Kanal Sorgula</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/analiz" data-key="menu_trends">Trend Analizi</a></li>
                </ul>
                <button class="btn btn-outline-light btn-sm" onclick="toggleLanguage()">
                    <i class="fas fa-globe"></i> <span id="lang-display">EN</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        
        <div class="d-flex justify-content-between align-items-center flex-wrap mb-4">
            <div>
                <h2 class="fw-bold mb-0"><i class="fas fa-chart-bar text-danger"></i> <span data-key="page_title">Piyasa Analizi & Niş Keşfi</span></h2>
                <p class="text-muted" data-key="page_subtitle">Trend videolardan otomatik çıkarılan veriler.</p>
            </div>
            <div class="d-flex gap-2">
                <select id="regionSelect" class="form-select" style="width: 150px;">
                    <option value="TR">Türkiye (TR)</option>
                    <option value="US">USA (US)</option>
                    <option value="DE">Germany (DE)</option>
                    <option value="GB">UK (GB)</option>
                </select>
                <button class="btn btn-danger" onclick="fetchTrends()" data-key="btn_analyze">ANALİZ ET</button>
            </div>
        </div>

        <div class="loader" id="loader"></div>

        <div id="analysis-results" style="display: none;">
            <div class="row">
                
                <div class="col-md-7">
                    <div class="analysis-card">
                        <div class="card-header-custom">
                            <i class="fas fa-key"></i> <span data-key="keywords_title">En Çok Aranan Anahtar Kelimeler</span>
                        </div>
                        <p class="text-muted small" data-key="keywords_desc">Trend videolarda en sık geçen ve rekabet yaratan kelimeler.</p>
                        
                        <div class="tag-cloud" id="tag-container">
                            </div>
                    </div>
                </div>

                <div class="col-md-5">
                    <div class="analysis-card h-100">
                        <div class="card-header-custom">
                            <i class="fas fa-bolt"></i> <span data-key="niche_title">Rekabet / Niş Durumu</span>
                        </div>
                        
                        <div class="mb-4">
                            <small class="text-muted d-block text-uppercase" data-key="total_tags">TOPLAM ETİKET ANALİZİ</small>
                            <span class="fs-4 fw-bold" id="total-tags-count">0</span>
                        </div>

                        <div class="mb-4">
                            <small class="text-muted d-block text-uppercase" data-key="dominant_cat">BASKIN KATEGORİ</small>
                            <span class="fs-5 fw-bold text-dark" id="dominant-cat">-</span>
                            <div class="small text-muted" data-key="auto_detect">(Otomatik Tespit)</div>
                        </div>

                        <div>
                            <small class="text-muted d-block text-uppercase" data-key="opp_score">FIRSAT SKORU</small>
                            <div class="score-text" id="opp-score">-</div>
                            <div class="small text-muted" id="opp-desc">Çeşitlilik var, niş fırsatı yüksek.</div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="analysis-card mt-3">
                <div class="card-header-custom" data-key="top_videos">Analiz Edilen Videolar</div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th data-key="col_video">Video</th>
                                <th data-key="col_channel">Kanal</th>
                                <th data-key="col_views">İzlenme</th>
                            </tr>
                        </thead>
                        <tbody id="video-table-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        let currentLang = 'TR';
        
        const DICTIONARY = {
            'TR': {
                menu_home: 'Ana Sayfa', menu_query: 'Kanal Sorgula', menu_trends: 'Trend Analizi',
                page_title: 'Piyasa Analizi & Niş Keşfi', page_subtitle: 'Trend videolardan otomatik çıkarılan veriler.',
                btn_analyze: 'ANALİZ ET',
                keywords_title: 'En Çok Aranan Anahtar Kelimeler',
                keywords_desc: 'Trend videolarda en sık geçen ve rekabet yaratan kelimeler.',
                niche_title: 'Rekabet / Niş Durumu',
                total_tags: 'TOPLAM ETİKET ANALİZİ',
                dominant_cat: 'BASKIN KATEGORİ',
                auto_detect: '(Otomatik Tespit)',
                opp_score: 'FIRSAT SKORU',
                top_videos: 'Analiz Edilen Videolar',
                col_video: 'Video', col_channel: 'Kanal', col_views: 'İzlenme',
                score_high: 'Yüksek', score_med: 'Orta', score_low: 'Düşük',
                desc_high: 'Çeşitlilik var, niş fırsatı yüksek.',
                desc_low: 'Rekabet çok yüksek, giriş zor.'
            },
            'EN': {
                menu_home: 'Home', menu_query: 'Channel Query', menu_trends: 'Trend Analysis',
                page_title: 'Market Analysis & Niche Discovery', page_subtitle: 'Data automatically extracted from trending videos.',
                btn_analyze: 'ANALYZE',
                keywords_title: 'Most Searched Keywords',
                keywords_desc: 'Most frequent and competitive keywords in trending videos.',
                niche_title: 'Competition / Niche Status',
                total_tags: 'TOTAL TAGS ANALYZED',
                dominant_cat: 'DOMINANT CATEGORY',
                auto_detect: '(Auto Detect)',
                opp_score: 'OPPORTUNITY SCORE',
                top_videos: 'Analyzed Videos',
                col_video: 'Video', col_channel: 'Channel', col_views: 'Views',
                score_high: 'High', score_med: 'Medium', score_low: 'Low',
                desc_high: 'High diversity, good niche opportunity.',
                desc_low: 'High competition, hard to enter.'
            }
        };

        function toggleLanguage() {
            currentLang = currentLang === 'TR' ? 'EN' : 'TR';
            document.getElementById('lang-display').innerText = currentLang === 'TR' ? 'EN' : 'TR';
            applyLanguage();
        }

        function applyLanguage() {
            const dict = DICTIONARY[currentLang];
            document.querySelectorAll('[data-key]').forEach(el => {
                el.innerText = dict[el.getAttribute('data-key')];
            });
        }

        async function fetchTrends() {
            const region = document.getElementById('regionSelect').value;
            document.getElementById('loader').style.display = 'block';
            document.getElementById('analysis-results').style.display = 'none';

            try {
                // Python API'sinden veriyi çekiyoruz (app.py'deki /api/trending)
                const res = await fetch(`/api/trending?region=${region}&limit=15`);
                const data = await res.json();
                
                processAndRender(data);
            } catch (e) {
                console.error(e);
                alert("Veri çekilirken hata oluştu!");
            } finally {
                document.getElementById('loader').style.display = 'none';
            }
        }

        function processAndRender(videos) {
            // --- 1. Etiket Analizi ---
            let allTags = [];
            videos.forEach(v => {
                if(v.tags) {
                    // Bazı etiketler string gelebilir, array olduğundan emin olalım
                    const tags = Array.isArray(v.tags) ? v.tags : JSON.parse(v.tags.replace(/'/g, '"'));
                    allTags = allTags.concat(tags);
                }
            });

            // Frekans Sayma
            const counts = {};
            allTags.forEach(tag => {
                const t = tag.toLowerCase();
                counts[t] = (counts[t] || 0) + 1;
            });

            // Sıralama
            const sortedTags = Object.entries(counts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 12); // İlk 12 etiketi al

            // --- 2. HTML'e Basma (Keyword Cloud) ---
            const container = document.getElementById('tag-container');
            container.innerHTML = '';
            sortedTags.forEach(([tag, count]) => {
                container.innerHTML += `<div class="tag-pill">${tag} <span>${count}</span></div>`;
            });

            // --- 3. Niş Analizi Hesaplama ---
            document.getElementById('total-tags-count').innerText = allTags.length;
            
            // Basit Kategori Tahmini (En çok geçen kelimelere bakarak)
            let category = currentLang === 'TR' ? "Genel / Karışık" : "General / Mixed";
            const topKeywords = sortedTags.map(x => x[0]).join(" ");
            
            if(topKeywords.includes("oyun") || topKeywords.includes("game") || topKeywords.includes("minecraft")) category = "Gaming & Entertainment";
            else if(topKeywords.includes("haber") || topKeywords.includes("sondakika")) category = "News & Politics";
            else if(topKeywords.includes("vlog") || topKeywords.includes("challenge")) category = "Vlog & Lifestyle";
            else if(topKeywords.includes("futbol") || topKeywords.includes("spor")) category = "Sports";
            
            document.getElementById('dominant-cat').innerText = category;

            // Fırsat Skoru (Etiket çeşitliliği çoksa fırsat yüksektir mantığı)
            const uniqueRatio = Object.keys(counts).length / allTags.length;
            let scoreEl = document.getElementById('opp-score');
            let descEl = document.getElementById('opp-desc');
            const dict = DICTIONARY[currentLang];

            if(uniqueRatio > 0.6) {
                scoreEl.innerText = dict.score_high;
                scoreEl.className = "score-text text-high";
                descEl.innerText = dict.desc_high;
            } else {
                scoreEl.innerText = dict.score_low;
                scoreEl.className = "score-text text-low";
                descEl.innerText = dict.desc_low;
            }

            // --- 4. Videoları Listeleme ---
            const tbody = document.getElementById('video-table-body');
            tbody.innerHTML = '';
            videos.slice(0, 5).forEach(v => {
                tbody.innerHTML += `
                    <tr>
                        <td><a href="${v.url}" target="_blank" class="text-decoration-none fw-bold text-dark">${v.title.substring(0,50)}...</a></td>
                        <td>${v.channel}</td>
                        <td>${v.views.toLocaleString()}</td>
                    </tr>
                `;
            });

            document.getElementById('analysis-results').style.display = 'block';
        }
    </script>
</body>
</html>
